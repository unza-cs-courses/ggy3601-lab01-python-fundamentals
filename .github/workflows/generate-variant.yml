name: Generate Student Variant

on:
  create:

jobs:
  generate:
    runs-on: ubuntu-latest
    if: github.event.ref_type == 'branch' && github.event.ref == 'main'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Extract Student Username
        id: student
        run: |
          # Repo name format: ggy3601-lab01-python-fundamentals-username
          REPO_NAME="${{ github.event.repository.name }}"
          USERNAME="${REPO_NAME##*-}"
          echo "username=${USERNAME}" >> $GITHUB_OUTPUT
          echo "Detected student: ${USERNAME}"

      - name: Generate Variant Config
        run: |
          python scripts/variant_generator.py \
            --assignment lab01 \
            --student "${{ steps.student.outputs.username }}" \
            --strategy grouped \
            --output config > .variant_config.json

          echo "Generated variant for ${{ steps.student.outputs.username }}:"
          cat .variant_config.json

      - name: Update Assignment README
        run: |
          python -c "
          import json

          with open('.variant_config.json') as f:
              config = json.load(f)

          params = config['parameters']

          # Read template and fill in variant values
          with open('README_TEMPLATE.md') as f:
              template = f.read()

          template = template.replace('{sample_depth}', str(params['sample_depth']))
          template = template.replace('{sample_mass}', str(params['sample_mass']))
          template = template.replace('{sample_volume}', str(params['sample_volume']))
          template = template.replace('{rock_type}', params['rock_type'])
          template = template.replace('{grade_value}', str(params['grade_value']))

          with open('ASSIGNMENT.md', 'w') as f:
              f.write(template)

          print('Generated personalized ASSIGNMENT.md')
          "

      - name: Commit Variant Files
        run: |
          git config user.name "GitHub Classroom"
          git config user.email "noreply@github.com"
          git add .variant_config.json ASSIGNMENT.md
          git commit -m "Generate unique variant for ${{ steps.student.outputs.username }}" || echo "No changes to commit"
          git push || echo "Nothing to push"
